name: 2ï¸âƒ£ Approval & Merge to Main

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  merge:
    name: Merge dev branch into main on approval
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

      - name: ðŸŒ³ Prepare main branch
        run: |
          # Fetch the develop branch
          git fetch origin develop

          # Ensure main exists
          if ! git rev-parse --verify origin/main >/dev/null 2>&1; then
            echo "main does not exist yet, creating it..."
            git checkout -b main
            git push origin main
          else
            git checkout main
          fi

      - name: ðŸ”„ Merge develop â†’ main
        run: |
          git fetch origin develop
          git merge origin/develop --no-ff -m "Release approved - ${{ github.event.release.tag_name }}"

      - name: ðŸ·ï¸ Create Release Tag
        id: tag
        run: |
          # Extract version from the RC tag and create production version
          RC_TAG="${{ github.event.release.tag_name }}"
          # Remove the RC suffix to create production tag (e.g., v0.0.0-rc.123.abc -> v1.0.0)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          RELEASE_TAG="v1.0.${COMMIT_COUNT}"

          echo "Creating production tag ${RELEASE_TAG} from RC ${RC_TAG}"
          git tag -a "${RELEASE_TAG}" -m "Release ${RELEASE_TAG} (from ${RC_TAG})"
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Push to GitHub
        run: |
          git push origin main
          git push origin ${{ steps.tag.outputs.release_tag }}
          echo "âœ… Merged to main and pushed tag ${{ steps.tag.outputs.release_tag }}"
