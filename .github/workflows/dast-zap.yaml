name: DAST - OWASP ZAP Scan

on:
  workflow_dispatch:
  pull_request:
    branches: [ "develop", "main" ]

permissions:
  contents: read

jobs:
  zap-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Start Application Stack
        run: |
          echo "üöÄ Starting full application stack for DAST..."
          docker compose -f docker-compose.test.yml up -d --build

          echo "‚è≥ Waiting for services to be ready..."
          for i in {1..60}; do
            if curl -sSf http://localhost:3000/health >/dev/null 2>&1; then
              echo "‚úÖ Auth service is ready!"
              break
            fi
            echo "Attempt $i/60 - Waiting for auth service..."
            sleep 3
          done

          # Verify service is accessible
          curl http://localhost:3000/health || echo "‚ö†Ô∏è Service might not be fully ready"

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        continue-on-error: true
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          fail_action: false
          artifact_name: 'zap-scan-results'

      - name: Verify ZAP Reports
        if: always()
        run: |
          echo "Checking ZAP reports..."
          ls -lah report_html.html report_json.json report_md.md || echo "‚ö†Ô∏è Some reports missing"

      - name: Upload DAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-reports
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

      - name: Stop Application Stack
        if: always()
        run: |
          echo "üõë Stopping application stack..."
          docker compose -f docker-compose.test.yml down -v
