name: Deploy to Staging

on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: [frontend, auth, discord-notifier]
      fail-fast: false

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build Docker Image - ${{ matrix.service }}
        working-directory: ./services/${{ matrix.service }}
        run: |
          echo "ðŸ³ Building Docker image for ${{ matrix.service }}..."

          if [ ! -f "Dockerfile" ]; then
            echo "âš ï¸ No Dockerfile found for ${{ matrix.service }}, creating default..."
            cat > Dockerfile << 'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci --only=production
          COPY . .
          RUN npm run build || echo "No build script"
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF
          fi

          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:latest .
          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:staging-latest .

      - name: ðŸ“¤ Push Docker Image - ${{ matrix.service }}
        run: |
          echo "ðŸ“¤ Pushing Docker image for ${{ matrix.service }}..."
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:staging-latest
          echo "âœ… Image push complete"

  notify-discord:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always()

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install Discord Notifier
        working-directory: ./services/discord-notifier
        run: npm install

      - name: ðŸ—ï¸ Build Discord Notifier
        working-directory: ./services/discord-notifier
        run: npm run build

      - name: ðŸ”” Send Notification
        working-directory: ./services/discord-notifier
        env:
          DISCORD_ENABLED: 'true'
          SEND_PIPELINE_SUCCESS: 'true'
          SEND_PIPELINE_FAILURE: 'true'
          DISCORD_WEBHOOK_QA: ${{ secrets.DISCORD_WEBHOOK_QA }}
          DISCORD_WEBHOOK_DEVELOPER: ${{ secrets.DISCORD_WEBHOOK_DEVELOPER }}
          DISCORD_WEBHOOK_STAKEHOLDER: ${{ secrets.DISCORD_WEBHOOK_STAKEHOLDER }}
        run: |
          # Start Discord notifier service
          npm start > /tmp/discord-service.log 2>&1 &
          NOTIFIER_PID=$!

          # Wait for service to start and check if it's running
          sleep 5
          if ! ps -p $NOTIFIER_PID > /dev/null 2>&1; then
            echo "âŒ Service failed to start. Logs:"
            cat /tmp/discord-service.log
          fi

          # Determine status
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            STATUS="success"
          else
            STATUS="failure"
            FAILED_SERVICES='["Check Actions tab for details"]'
          fi

          # Send notification (continue even if curl fails)
          curl -v -X POST http://localhost:3001/notify/pipeline \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Token: test-token" \
            -d '{
              "status": "'"$STATUS"'",
              "workflowName": "Deploy to Staging",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "actor": "${{ github.actor }}",
              "runUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'",
              "failedServices": '"${FAILED_SERVICES:-[]}"'
            }' || echo "âš ï¸ Notification request failed (service may not be running)"

          # Cleanup
          kill $NOTIFIER_PID 2>/dev/null || true

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push, notify-discord]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸš€ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.build-and-push.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Services" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`devops-frontend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Auth: \`devops-auth:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Discord Notifier: \`devops-discord-notifier:latest\`" >> $GITHUB_STEP_SUMMARY
