name: "1ï¸âƒ£ RC Draft Release"

on:
  workflow_run:
    workflows: ["CI Quality Gate"]
    types: [completed]
  workflow_dispatch:  # Allow manual trigger for testing


permissions:
  contents: write

jobs:
  create-draft-release:
    name: Create Draft Release
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop') }}
    # Note: Push event is only to register the workflow, actual execution requires workflow_dispatch or workflow_run

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && 'develop' || github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: ðŸ·ï¸ Generate RC Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
          else
            SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          fi
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          RC_VERSION="v0.0.0-rc.${TIMESTAMP}.${SHORT_SHA}"
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT
          echo "RC Version: ${RC_VERSION}"

      - name: ðŸ“¤ Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.rc_version }}
          draft: true
          body: |
            # Release Candidate
            **Version:** ${{ steps.version.outputs.rc_version }}
            **Status:** Waiting for team approval
            **Branch:** develop
            **Commit:** ${{ github.event_name == 'workflow_dispatch' && github.sha || github.event.workflow_run.head_sha }}
            **Triggered by:** ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'CI Quality Gate' }}

            ## What's Included
            - âœ… All tests passed
            - âœ… Code quality checks completed (ESLint)
            - âœ… Unit tests completed with coverage
            - âœ… Build artifacts created

            ## To Approve
            ${{ github.event_name == 'workflow_run' && format('Review the test reports in the [CI Quality Gate workflow]({0}), then:', github.event.workflow_run.html_url) || 'Review the latest test reports in the Actions tab, then:' }}
            1. Edit this release
            2. Click **Publish release**

            This will trigger the merge to `main` and deployment to staging.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
