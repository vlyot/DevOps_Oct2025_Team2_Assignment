name: "1ï¸âƒ£ RC Draft Release"

on:
  workflow_run:
    workflows: ["CI Quality Gate"]
    types: [completed]

permissions:
  contents: write
  actions: read

jobs:
  create-draft-release:
    name: Create Draft Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop' }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: ğŸ·ï¸ Generate RC Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
          else
            SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          fi
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          RC_VERSION="v0.0.0-rc.${TIMESTAMP}.${SHORT_SHA}"
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT
          echo "RC Version: ${RC_VERSION}"

      - name: ğŸ“¤ Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.rc_version }}
          draft: true
          body: |
            # Release Candidate
            **Version:** ${{ steps.version.outputs.rc_version }}
            **Status:** Waiting for team approval
            **Branch:** develop
            **Commit:** ${{ github.event.workflow_run.head_sha }}

            ## What's Included
            - âœ… All tests passed
            - âœ… Code quality checks completed (ESLint)
            - âœ… Unit tests completed with coverage
            - âœ… Build artifacts created

            ## CI Quality Gate
            Review the test reports in the [CI Quality Gate workflow](${{ github.event.workflow_run.html_url }})

            ## To Approve & Deploy
            1. Review test results and quality reports
            2. Edit this release
            3. Click **Publish release**

            Publishing will trigger:
            - âœ… Merge to `main` branch
            - ğŸ·ï¸ Production version tag creation
            - ğŸš€ Automatic deployment to staging
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}