name: 1ï¸âƒ£ RC Draft Release

on:
  workflow_run:
    workflows: ["CI Quality Gate"]
    types: [completed]
    branches: [develop]

permissions:
  contents: write

jobs:
  rc-draft:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          # FIX: Explicitly checkout the commit that triggered this workflow
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: ðŸ·ï¸ Generate RC Version
        id: version
        run: |
          # Use the SHA from the triggering event
          SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          RC_VERSION="v0.0.0-rc.${TIMESTAMP}.${SHORT_SHA}"
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT
          echo "RC Version: ${RC_VERSION}"

      - name: ðŸ“¤ Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.rc_version }}
          target_commitish: ${{ github.event.workflow_run.head_sha }} # FIX: Ensure tag points to right commit
          draft: true
          body: |
            # Release Candidate
            **Version:** ${{ steps.version.outputs.rc_version }}
            **Status:** Waiting for QA approval
            **Commit:** ${{ github.event.workflow_run.head_sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
