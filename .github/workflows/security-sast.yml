name: Security - SAST (Static Analysis)


on:
  workflow_run:
    workflows: ["CI Quality Gate"]
    types: [completed]
    branches: ["feat/testing-pipelines"]   # same branch as CI
  # (keep or remove schedule as you like)


permissions:
  security-events: write
  contents: read

jobs:
  sast-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Run SAST (Semgrep) - Full Codebase
        run: |
          echo "ðŸ”’ Running Semgrep SAST scan on entire codebase..."
          
          # Generate SARIF report
          docker run --rm \
            -v "${{ github.workspace }}:/src" \
            returntocorp/semgrep \
            semgrep scan /src \
            --config auto \
            --sarif \
            --output /src/sast-report.sarif || true
          
          # Generate JSON report
          docker run --rm \
            -v "${{ github.workspace }}:/src" \
            returntocorp/semgrep \
            semgrep scan /src \
            --config auto \
            --json \
            --output /src/sast-report.json || true
          
          # Create HTML report using Python
          python3 -c '
          import json
          import html
          
          # Read JSON data
          try:
              with open("sast-report.json", "r") as f:
                  data = json.load(f)
          except:
              data = {"results": []}
          
          results = data.get("results", [])
          
          # Count severities
          counts = {"high": 0, "medium": 0, "low": 0, "info": 0}
          for r in results:
              sev = r.get("extra", {}).get("severity", "info").lower()
              counts[sev] = counts.get(sev, 0) + 1
          
          # Generate HTML
          html_output = """<!DOCTYPE html>
          <html>
          <head>
              <title>Semgrep SAST Report - All Services</title>
              <meta charset=\"UTF-8\">
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                  h1 { color: #333; }
                  .summary { background: white; padding: 20px; margin: 20px 0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  .finding { background: white; padding: 15px; margin: 15px 0; border-left: 4px solid #e74c3c; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  .finding.high { border-left-color: #e74c3c; }
                  .finding.medium { border-left-color: #f39c12; }
                  .finding.low { border-left-color: #3498db; }
                  .finding.info { border-left-color: #95a5a6; }
                  .code { background: #2d2d2d; color: #f8f8f2; padding: 12px; border-radius: 4px; overflow-x: auto; margin: 10px 0; font-family: monospace; font-size: 13px; }
                  .severity { font-weight: bold; padding: 4px 10px; border-radius: 3px; color: white; display: inline-block; margin-right: 10px; font-size: 12px; }
                  .severity.high { background: #e74c3c; }
                  .severity.medium { background: #f39c12; }
                  .severity.low { background: #3498db; }
                  .severity.info { background: #95a5a6; }
                  .no-findings { background: white; padding: 40px; text-align: center; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  .no-findings h2 { color: #27ae60; margin: 0; }
                  .no-findings p { color: #666; margin-top: 10px; }
                  h3 { margin: 0 0 10px 0; }
                  .file-path { color: #555; font-size: 14px; margin: 8px 0; }
                  .message { color: #333; line-height: 1.6; margin: 10px 0; }
                  .service-tag { background: #3498db; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px; }
              </style>
          </head>
          <body>
              <h1>ðŸ”’ Semgrep SAST Report - All Services</h1>
          """
          
          # Add summary
          html_output += f"""
              <div class="summary">
                  <h3>Summary</h3>
                  <p><strong>Total Findings:</strong> {len(results)}</p>
                  <p>
                      <span class="severity high">{counts.get("high", 0)} High</span>
                      <span class="severity medium">{counts.get("medium", 0)} Medium</span>
                      <span class="severity low">{counts.get("low", 0)} Low</span>
                      <span class="severity info">{counts.get("info", 0)} Info</span>
                  </p>
              </div>
          """
          
          # Add findings or no-findings message
          if len(results) == 0:
              html_output += """
              <div class="no-findings">
                  <h2>âœ… No security issues found!</h2>
                  <p>All services passed Semgrep security checks.</p>
              </div>
              """
          else:
              for finding in results:
                  severity = finding.get("extra", {}).get("severity", "info").lower()
                  check_id = html.escape(finding.get("check_id", "Unknown Check"))
                  path = html.escape(finding.get("path", "Unknown"))
                  
                  # Extract service name from path
                  service = "unknown"
                  if "services/" in path:
                      service = path.split("services/")[1].split("/")[0]
                  
                  line = finding.get("start", {}).get("line", "?")
                  message = html.escape(finding.get("extra", {}).get("message") or finding.get("message", "No description"))
                  lines = html.escape(finding.get("extra", {}).get("lines", ""))
                  
                  html_output += f"""
              <div class="finding {severity}">
                  <h3>
                      <span class="severity {severity}">{severity.upper()}</span>
                      {check_id}
                      <span class="service-tag">{service}</span>
                  </h3>
                  <div class="file-path"><strong>File:</strong> {path}:{line}</div>
                  <div class="message"><strong>Message:</strong> {message}</div>
          """
                  if lines:
                      html_output += f"""
                  <div class="code"><pre>{lines}</pre></div>
          """
                  html_output += """
              </div>
          """
          
          html_output += """
          </body>
          </html>
          """
          
          # Write HTML file
          with open("sast-report.html", "w") as f:
              f.write(html_output)
          
          print("âœ… HTML report created successfully")
          '
          
          echo "=== Checking SAST reports ==="
          ls -lh sast-report.json sast-report.sarif sast-report.html || echo "Some SAST reports missing"

      - name: 3. Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: sast-report.sarif
          category: semgrep

      - name: 4. Upload SAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports-all-services
          path: |
            sast-report.html
            sast-report.json
            sast-report.sarif
          retention-days: 30

      - name: 5. Generate SAST Summary
        if: always()
        run: |
          echo "## ðŸ”’ SAST Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Scan Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Tool:** Semgrep" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Scan Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Full codebase analysis" >> $GITHUB_STEP_SUMMARY
          echo "- All 5 services (frontend, auth, dashboard, api, user)" >> $GITHUB_STEP_SUMMARY
          echo "- Security-extended ruleset" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Reports Generated" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML Report** - Human-readable findings" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON Report** - Machine-readable data" >> $GITHUB_STEP_SUMMARY
          echo "- **SARIF Report** - GitHub Security integration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the **Security tab** for SARIF findings" >> $GITHUB_STEP_SUMMARY
          echo "2. Download HTML report for detailed analysis" >> $GITHUB_STEP_SUMMARY
          echo "3. Address HIGH/CRITICAL vulnerabilities before merging" >> $GITHUB_STEP_SUMMARY