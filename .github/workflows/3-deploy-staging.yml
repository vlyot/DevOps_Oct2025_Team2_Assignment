name: 3ï¸âƒ£ Deploy Tagged Release to Staging

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-and-push-docker:
    name: Build & push images for tagged release
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: [frontend, auth, discord-notifier]
      fail-fast: false

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build Docker image - ${{ matrix.service }}
        working-directory: ./services/${{ matrix.service }}
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "ğŸ³ Building Docker image for ${{ matrix.service }} with tag ${VERSION_TAG}..."

          if [ ! -f "Dockerfile" ]; then
            echo "âš ï¸ No Dockerfile found for ${{ matrix.service }}, creating default..."
            cat > Dockerfile << 'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci --only=production
          COPY . .
          RUN npm run build || echo "No build script"
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF
          fi

          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:${VERSION_TAG} .
          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:staging-latest .

      - name: ğŸ“¤ Push Docker image - ${{ matrix.service }}
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "ğŸ“¤ Pushing Docker image for ${{ matrix.service }}..."
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:${VERSION_TAG}
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:staging-latest
          echo "âœ… Image push complete"

  deploy-to-staging:
    name: Deploy to staging
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    environment:
      name: staging

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get Version from Tag
        id: version
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "version=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION_TAG}"

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci

      - name: âœ… Build & Verify All Services
        run: |
          echo "ğŸ¥ Building and verifying all services..."

          # Auth service
          cd services/auth
          npm ci
          npm run build
          echo "âœ… Auth service built successfully"

          # Frontend
          cd ../frontend
          npm ci
          npm run build
          echo "âœ… Frontend built successfully"

          # Discord Notifier
          cd ../discord-notifier
          npm ci
          npm run build
          echo "âœ… Discord notifier built successfully"

      - name: ğŸ“Š Deployment Report
        run: |
          VERSION_TAG="${{ steps.version.outputs.version }}"
          echo "ğŸ“Š Staging Deployment Report"
          echo "Version: ${VERSION_TAG}"
          echo "Timestamp: $(date -u)"
          echo "Status: âœ… Code verified and ready for deployment"
          echo ""
          echo "Next Steps:"
          echo "1. All services compiled and verified"
          echo "2. Ready for manual deployment to your staging environment"
          echo "3. Run: npm start (in each service directory)"
