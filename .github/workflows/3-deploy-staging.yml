name: 3Ô∏è‚É£ Deploy Tagged Release to Staging

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-and-push-docker:
    name: Build & push images for tagged release
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: [frontend, auth, discord-notifier]
      fail-fast: false

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèóÔ∏è Build Docker image - ${{ matrix.service }}
        working-directory: ./services/${{ matrix.service }}
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "üê≥ Building Docker image for ${{ matrix.service }} with tag ${VERSION_TAG}..."

          if [ ! -f "Dockerfile" ]; then
            echo "‚ö†Ô∏è No Dockerfile found for ${{ matrix.service }}, creating default..."
            cat > Dockerfile << 'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci --only=production
          COPY . .
          RUN npm run build || echo "No build script"
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF
          fi

          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:${VERSION_TAG} .
          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:staging-latest .

      - name: üì§ Push Docker image - ${{ matrix.service }}
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "üì§ Pushing Docker image for ${{ matrix.service }}..."
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:${VERSION_TAG}
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:staging-latest
          echo "‚úÖ Image push complete"

  deploy-to-staging:
    name: Deploy to staging environment (Render.com)
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    environment:
      name: staging

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üè∑Ô∏è Get Version from Tag
        id: version
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "version=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION_TAG}"

      - name: ‚è≥ Wait for Render deployment
        run: |
          echo "‚è≥ Render is auto-deploying from main branch..."
          echo "Main branch contains the latest tagged version"
          sleep 30

      - name: üè• Health Check - Frontend
        run: |
          STAGING_URL="${{ secrets.RENDER_STAGING_URL }}"
          echo "üè• Checking frontend health at ${STAGING_URL}..."

          for i in {1..60}; do
            if curl -sf "${STAGING_URL}/health" > /dev/null 2>&1; then
              echo "‚úÖ Frontend is healthy"
              exit 0
            fi
            echo "Attempt $i/60 - Waiting for frontend to be ready..."
            sleep 2
          done
          echo "‚ö†Ô∏è Frontend health check inconclusive (may still be deploying)"
          exit 0

      - name: üè• Health Check - Auth Service
        run: |
          STAGING_URL="${{ secrets.RENDER_STAGING_URL }}"
          AUTH_URL="${STAGING_URL}:3000"
          echo "üè• Checking auth service health at ${AUTH_URL}..."

          for i in {1..60}; do
            if curl -sf "${AUTH_URL}/health" > /dev/null 2>&1; then
              echo "‚úÖ Auth service is healthy"
              exit 0
            fi
            echo "Attempt $i/60 - Waiting for auth service to be ready..."
            sleep 2
          done
          echo "‚ö†Ô∏è Auth health check inconclusive (may still be deploying)"
          exit 0

      - name: üìä Deployment Report
        if: always()
        run: |
          VERSION_TAG="${{ steps.version.outputs.version }}"
          STAGING_URL="${{ secrets.RENDER_STAGING_URL }}"
          echo "üìä Staging Deployment Report"
          echo "Version: ${VERSION_TAG}"
          echo "Staging URL: ${STAGING_URL}"
          echo "Timestamp: $(date -u)"
          echo "Status: ‚úÖ Pushed to Render (auto-deploying)"
