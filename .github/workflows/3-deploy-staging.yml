name: 3Ô∏è‚É£ Deploy Tagged Release to Staging

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-and-push-docker:
    name: Build & push images for tagged release
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: [frontend, auth, discord-notifier]
      fail-fast: false

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèóÔ∏è Build Docker image - ${{ matrix.service }}
        working-directory: ./services/${{ matrix.service }}
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "üê≥ Building Docker image for ${{ matrix.service }} with tag ${VERSION_TAG}..."

          if [ ! -f "Dockerfile" ]; then
            echo "‚ö†Ô∏è No Dockerfile found for ${{ matrix.service }}, creating default..."
            cat > Dockerfile << 'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci --only=production
          COPY . .
          RUN npm run build || echo "No build script"
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF
          fi

          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:${VERSION_TAG} .
          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:staging-latest .

      - name: üì§ Push Docker image - ${{ matrix.service }}
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "üì§ Pushing Docker image for ${{ matrix.service }}..."
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:${VERSION_TAG}
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-${{ matrix.service }}:staging-latest
          echo "‚úÖ Image push complete"

  deploy-to-staging:
    name: Deploy to staging environment
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    environment:
      name: staging

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üè∑Ô∏è Get Version from Tag
        id: version
        run: |
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "version=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION_TAG}"

      - name: üöÄ Deploy to Staging via SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_SERVER_HOST }} >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/id_rsa ${{ secrets.STAGING_SSH_USER }}@${{ secrets.STAGING_SERVER_HOST }} << 'EOF'
          set -e

          VERSION_TAG="${{ steps.version.outputs.version }}"
          echo "üöÄ Deploying version ${VERSION_TAG} to staging..."

          # Navigate to project directory
          cd ~/devsecops-staging

          # Login to Docker Hub
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

          # Pull latest images
          docker pull ${{ secrets.DOCKER_USERNAME }}/devops-frontend:${VERSION_TAG}
          docker pull ${{ secrets.DOCKER_USERNAME }}/devops-auth:${VERSION_TAG}
          docker pull ${{ secrets.DOCKER_USERNAME }}/devops-discord-notifier:${VERSION_TAG}

          # Stop old containers
          docker-compose down || true

          # Update docker-compose.yml with new version
          sed -i "s|image:.*devops-frontend:.*|image: ${{ secrets.DOCKER_USERNAME }}/devops-frontend:${VERSION_TAG}|g" docker-compose.yml
          sed -i "s|image:.*devops-auth:.*|image: ${{ secrets.DOCKER_USERNAME }}/devops-auth:${VERSION_TAG}|g" docker-compose.yml
          sed -i "s|image:.*devops-discord-notifier:.*|image: ${{ secrets.DOCKER_USERNAME }}/devops-discord-notifier:${VERSION_TAG}|g" docker-compose.yml

          # Start new containers
          docker-compose up -d

          echo "‚úÖ Deployment complete - version ${VERSION_TAG}"
          EOF

      - name: üè• Health Check - Frontend
        run: |
          echo "üè• Checking frontend health at http://localhost..."

          for i in {1..30}; do
            if curl -sf http://${{ secrets.STAGING_SERVER_HOST }}/health > /dev/null 2>&1; then
              echo "‚úÖ Frontend is healthy"
              exit 0
            fi
            echo "Attempt $i/30 - Waiting for frontend to be ready..."
            sleep 2
          done
          echo "‚ö†Ô∏è Frontend health check inconclusive (may still be deploying)"
          exit 0

      - name: üè• Health Check - Auth Service
        run: |
          echo "üè• Checking auth service health at http://localhost:3000..."

          for i in {1..30}; do
            if curl -sf http://${{ secrets.STAGING_SERVER_HOST }}:3000/health > /dev/null 2>&1; then
              echo "‚úÖ Auth service is healthy"
              exit 0
            fi
            echo "Attempt $i/30 - Waiting for auth service to be ready..."
            sleep 2
          done
          echo "‚ö†Ô∏è Auth health check inconclusive (may still be deploying)"
          exit 0

      - name: üìä Deployment Report
        if: always()
        run: |
          VERSION_TAG="${{ steps.version.outputs.version }}"
          echo "üìä Staging Deployment Report"
          echo "Version: ${VERSION_TAG}"
          echo "Staging Server: ${{ secrets.STAGING_SERVER_HOST }}"
          echo "Timestamp: $(date -u)"
          echo "Status: ‚úÖ Deployed to staging"
