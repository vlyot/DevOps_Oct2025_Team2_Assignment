name: Security - DAST (Dynamic Analysis)

on:
  pull_request:
    branches: [ "feat/testing-pipelines" ]  # PRs into this branch
  push:
    branches: [ "feat/testing-pipelines" ]  # direct pushes/merges into this branch
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dast-scan:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Install Auth Service Dependencies
        working-directory: ./services/auth
        run: npm ci # clean install of dependencies

      - name: 4. Start Auth Service
        working-directory: ./services/auth
        run: |
          echo "ðŸš€ Starting auth service for DAST scanning..."
          # Create temporary .env file with dummy values
          cat > .env << EOF
          SUPABASE_URL=https://dummy.supabase.co
          SUPABASE_ANON_KEY=dummy-key-for-scanning
          JWT_SECRET=test-secret-for-dast-only
          PORT=3000
          EOF

          # Start service in background
          npx ts-node src/index.ts &

          # Wait for service to be ready
          echo "â³ Waiting for service to start..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… Auth service is ready!"
              break
            fi
            echo "Attempt $i/30 - Service not ready yet..."
            sleep 2
          done

          # Verify service is running
          curl http://localhost:3000/health || echo "âš ï¸ Service might not be ready"

      - name: 5. Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'  # -a = AJAX spider, -j = JSON report
          fail_action: false  # Don't fail build, just report findings
          artifact_name: 'zap-scan-results'
          issue_title: 'DAST Security Scan Results'
        continue-on-error: true

      - name: 6. Upload DAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-security-reports
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

      - name: 7. Generate DAST Summary
        if: always()
        run: |
          echo "## ðŸ”’ DAST Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Scan Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Tool:** OWASP ZAP" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** Auth Service (http://localhost:3000)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Scan Type" >> $GITHUB_STEP_SUMMARY
          echo "- Baseline passive scan" >> $GITHUB_STEP_SUMMARY
          echo "- AJAX spider enabled" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime security testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Reports Generated" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML Report** - Detailed findings" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON Report** - Machine-readable data" >> $GITHUB_STEP_SUMMARY
          echo "- **Markdown Report** - Summary format" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
          echo "Review DAST reports for runtime vulnerabilities before deploying." >> $GITHUB_STEP_SUMMARY