name: Notify - Pipeline Status

on:
  workflow_run:
    workflows: ["CI - Matrix Tests", "SAST - Semgrep Scan", "SCA - NPM Audit", "DAST - OWASP ZAP Scan"]
    types: [completed]
    branches: [ "develop", "main" ]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Determine Pipeline Status
        id: status
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" == "failure" ]]; then
            echo "pipeline_status=failure" >> $GITHUB_OUTPUT
            echo "status_emoji=‚ùå" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "pipeline_status=success" >> $GITHUB_OUTPUT
            echo "status_emoji=‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "pipeline_status=unknown" >> $GITHUB_OUTPUT
            echo "status_emoji=‚ö†Ô∏è" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord Notification
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            echo "üìß Sending Discord notification..."
            curl -H "Content-Type: application/json" \
            -d "{\"content\": \"${{ steps.status.outputs.status_emoji }} **Pipeline ${{ steps.status.outputs.pipeline_status }}**\n**Workflow:** ${{ github.event.workflow_run.name }}\n**Branch:** ${{ github.event.workflow_run.head_branch }}\n**Actor:** ${{ github.event.workflow_run.actor.login }}\n**Run:** ${{ github.event.workflow_run.html_url }}\"}" \
            $DISCORD_WEBHOOK || echo "‚ö†Ô∏è Discord notification failed"
          else
            echo "‚ö†Ô∏è Discord webhook not configured, skipping"
          fi

      - name: Send Email Notification
        continue-on-error: true
        run: |
          cat > payload.json <<'PAYLOAD_EOF'
          {
            "status": "${{ steps.status.outputs.pipeline_status }}",
            "workflow": "${{ github.event.workflow_run.name }}",
            "branch": "${{ github.event.workflow_run.head_branch }}",
            "commit": "${{ github.event.workflow_run.head_sha }}",
            "actor": "${{ github.event.workflow_run.actor.login }}",
            "runUrl": "${{ github.event.workflow_run.html_url }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          PAYLOAD_EOF

          echo "üìß Sending email notification..."
          AUTH_URL="${{ secrets.AUTH_SERVICE_URL || 'http://localhost:3000' }}"

          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "X-Pipeline-Token: ${{ secrets.PIPELINE_NOTIFICATION_TOKEN }}" \
            -d @payload.json \
            "$AUTH_URL/pipeline/notify" 2>&1 || echo -e "\n000")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Email notification sent successfully"
            echo "$body"
          else
            echo "‚ö†Ô∏è Email notification failed (HTTP $http_code)"
            echo "$body"
            echo "Note: This does not affect pipeline status"
          fi
